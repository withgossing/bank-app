#!/bin/bash

# Bank Application ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸

set -e

echo "ðŸ¦ Bank Application ë¹Œë“œ ì‹œìž‘"
echo "============================"
echo ""

# ìƒ‰ìƒ ì •ì˜
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# í”„ë¡œì íŠ¸ ë£¨íŠ¸
PROJECT_ROOT="/Users/gossing/WorkPlace/bank-app"
cd "$PROJECT_ROOT"

# Gradle Wrapper ìƒì„± í•¨ìˆ˜
create_gradle_wrapper() {
    local service_dir=$1
    echo "Gradle Wrapper ìƒì„±: $service_dir"
    
    cd "$service_dir"
    
    # gradle-wrapper.properties ìƒì„±
    mkdir -p gradle/wrapper
    cat > gradle/wrapper/gradle-wrapper.properties << EOF
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF

    # gradlew ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    cat > gradlew << 'EOF'
#!/bin/sh

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
##############################################################################

# Attempt to set APP_HOME
DIRNAME=$(dirname "$0")
APP_HOME=$(cd "$DIRNAME" && pwd)

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum

# OS specific support
case "$(uname)" in
  CYGWIN* | MINGW* | MSYS*)
    cygwin=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ]; then
    JAVACMD=$JAVA_HOME/bin/java
else
    JAVACMD=java
fi

# Increase the maximum file descriptors if we can.
if [ "$MAX_FD" != "maximum" ]; then
    MAX_FD_LIMIT=$(ulimit -H -n)
    if [ $? -eq 0 ]; then
        if [ "$MAX_FD" = "maximum" ] || [ "$MAX_FD" = "max" ]; then
            MAX_FD=$MAX_FD_LIMIT
        fi
        ulimit -n $MAX_FD
    fi
fi

exec "$JAVACMD" \
  -classpath "$CLASSPATH" \
  org.gradle.wrapper.GradleWrapperMain \
  "$@"
EOF

    chmod +x gradlew
    cd "$PROJECT_ROOT"
}

# ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ëª©ë¡
BACKEND_SERVICES=(
    "discovery-service"
    "gateway-service"
    "user-service"
    "account-service"
    "product-service"
)

echo "1. Gradle Wrapper ì„¤ì •"
echo "====================="
for service in "${BACKEND_SERVICES[@]}"; do
    create_gradle_wrapper "$service"
    echo -e "${GREEN}âœ“${NC} $service"
done

echo ""
echo "2. Docker ì´ë¯¸ì§€ ë¹Œë“œ"
echo "==================="
echo ""

# Docker Composeë¡œ ë¹Œë“œ
echo "Docker Compose ë¹Œë“œ ì‹œìž‘..."
docker-compose build

echo ""
echo -e "${GREEN}âœ… ë¹Œë“œ ì™„ë£Œ!${NC}"
echo ""
echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ì„¸ìš”:"
echo "  docker-compose up -d"
echo ""
echo "ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
echo "  docker-compose ps"
